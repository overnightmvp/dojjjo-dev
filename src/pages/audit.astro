---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Product & Authority Diagnostic" description="Run the DOJJJO protocol diagnostic to evaluate your brand's AI visibility and product execution readiness.">
	<main class="container animate-fade-in" style="padding: var(--space-xl) 0;">
		<div id="diagnostic-funnel" class="diagnostic-container">
			
			<!-- STEP 1: CATEGORY & INTENT -->
			<div class="step active" data-step="1">
				<div class="step-header">
					<span class="step-num">STEP_01 // INITIALIZING_DIAGNOSTIC</span>
					<h1>Where is the bottleneck?</h1>
					<p>In which area is your execution failing? <span class="text-accent">(42 founders audited this month)</span></p>
				</div>
				<div class="options-grid">
					<button class="option-card" data-value="Production">
						<span class="icon">⬢</span>
						<h3>Product Production</h3>
						<p style="font-size: 0.75rem; opacity: 0.7;">We can't ship fast enough.</p>
					</button>
					<button class="option-card" data-value="Authority">
						<span class="icon">⬡</span>
						<h3>Market Authority</h3>
						<p style="font-size: 0.75rem; opacity: 0.7;">AI agents don't cite us.</p>
					</button>
					<button class="option-card" data-value="Distribution">
						<span class="icon">⬣</span>
						<h3>Sales Distribution</h3>
						<p style="font-size: 0.75rem; opacity: 0.7;">Leads are cold and generic.</p>
					</button>
					<button class="option-card" data-value="FullStudio">
						<span class="icon">⬗</span>
						<h3>Full Studio Build</h3>
						<p style="font-size: 0.75rem; opacity: 0.7;">We need an end-to-end OS.</p>
					</button>
				</div>
			</div>

			<!-- STEP 2: INFRASTRUCTURE -->
			<div class="step" data-step="2">
				<div class="step-header">
					<span class="step-num">STEP_02 // INFRASTRUCTURE_CHECK</span>
					<h1>Entity Verification</h1>
					<p>How does the machine currently see your brand?</p>
				</div>
				<div class="input-stack">
					<div class="form-group">
						<label>Your Brand/Product URL</label>
						<input type="url" id="user-url" placeholder="https://yourbrand.com" required />
					</div>
					<div class="form-group">
						<label>Primary Authority Competitor</label>
						<input type="url" id="comp-url" placeholder="https://competitor.com" required />
					</div>
					<button class="btn btn-primary next-step">Proceed to Analysis</button>
				</div>
			</div>

			<!-- STEP 3: THE GAP -->
			<div class="step" data-step="3">
				<div class="step-header">
					<span class="step-num">STEP_03 // GAP_ANALYSIS</span>
					<h1>The Execution Gap</h1>
					<p>What is the primary "hallucination" or technical friction you're facing?</p>
				</div>
				<div class="input-stack">
					<div class="form-group">
						<label>Describe the friction</label>
						<textarea id="ai-gap" rows="4" placeholder="e.g. AI recommends our competitor, our MVP is stalled, or our outbound scripts aren't converting..."></textarea>
					</div>
					<button class="btn btn-primary next-step">Calculate Readiness Score</button>
				</div>
			</div>

			<!-- STEP 4: LEAD CAPTURE -->
			<div class="step" data-step="4">
				<div class="step-header">
					<span class="step-num">STEP_04 // SECURING_THE_PROTOCOL</span>
					<h1>Final Verification</h1>
					<p>Confirm your identity to receive the full diagnostic report.</p>
				</div>
				<form id="audit-lead-form">
					<div class="input-stack">
						<div class="form-group">
							<label>Your Name</label>
							<input type="text" id="user-name" placeholder="John Doe" required />
						</div>
						<div class="form-group">
							<label>Work Email</label>
							<input type="email" id="user-email" placeholder="john@yourbrand.com" required />
						</div>
						<button type="submit" class="btn btn-primary">Generate My Diagnostic</button>
					</div>
				</form>
			</div>

			<!-- STEP 5: SIMULATED ENGINE -->
			<div class="step" data-step="simulation" id="simulation-step">
				<div class="step-header">
					<span class="step-num">STATUS: RUNNING_STUDIO_ENGINE</span>
					<h1>Simulating Production_</h1>
					<p>Benchmarking entity velocity and execution readiness...</p>
				</div>
				<div class="terminal-simulation">
					<div class="terminal-logs" id="terminal-logs">
						<p class="log-line">> Initiating DOJJJO Protocol v4.2...</p>
					</div>
					<div class="progress-indicator-box">
						<div class="progress-bar-small">
							<div id="sim-progress"></div>
						</div>
						<span id="sim-status">INITIALIZING_BUFFERS...</span>
					</div>
				</div>
			</div>

			<!-- RESULTS -->
			<div class="step" data-step="results" id="results-step">
				<div class="result-header">
					<div class="score-circle">
						<span id="authority-score">24</span>
						<label>Readiness_Score</label>
					</div>
					<div class="result-text">
						<h2 style="color: var(--color-accent); font-size: 2.5rem; margin-bottom: 0.5rem;">DIAGNOSTIC_COMPLETE</h2>
						<p>Your "Readiness Score" is below the threshold for efficient scaling. Your brand is experiencing <strong class="text-white">Semantic Atrophy</strong> and production friction.</p>
					</div>
				</div>

				<div class="dual-path-grid">
					<div class="path-card surface">
						<h3>Option 1: The Manual Protocol (DIY)</h3>
						<p>Copy this prompt into GPT-4 or Perplexity to verify the gaps in your market authority and product visibility.</p>
						<div class="prompt-box">
							<pre id="custom-prompt-output"></pre>
							<button class="copy-btn" id="copy-prompt">Copy Prompt_</button>
						</div>
						<p class="path-note">Note: Static patches fail without systematic signal injection.</p>
					</div>

					<div class="path-card surface featured">
						<div class="badge">REQUIRED ACTION</div>
						<h3>Option 2: Retain DOJJJO</h3>
						<p>Stop guessing. Retain a Fractional Product Specialist to build your infrastructure or deploy the Authority Loop to secure your market position.</p>
						<a href="https://calendly.com/d/ctbg-rn5-x7j/johnny-toshio-30-minutes-intro" class="btn btn-primary w-full">Initialize Strategy Session_</a>
						<ul class="benefit-list">
							<li>Verified "Knowledge Graph" Injection</li>
							<li>Technical Roadmap & Vision Deck</li>
							<li>Full-Stack Production Velocity</li>
						</ul>
					</div>
				</div>
			</div>

			<div class="progress-bar">
				<div id="progress-indicator"></div>
			</div>
		</div>
	</main>
</Layout>

<script is:inline>
	let funnelData = {
		industry: '',
		userUrl: '',
		compUrl: '',
		aiGap: '',
		name: '',
		email: '',
		authority: 24
	};

	const steps = document.querySelectorAll('.step');
	const progressIndicator = document.getElementById('progress-indicator');
	const resultsStep = document.getElementById('results-step');

	// Step 1: Option Selection
	document.querySelectorAll('.option-card').forEach(card => {
		card.addEventListener('click', () => {
			funnelData.industry = card.dataset.value;
			goToStep(2);
		});
	});

	// Step 2 & 3: Next Buttons
	document.querySelectorAll('.next-step').forEach(btn => {
		btn.addEventListener('click', () => {
			const currentStep = btn.closest('.step').dataset.step;
			if (currentStep === '2') {
				funnelData.userUrl = document.getElementById('user-url').value;
				funnelData.compUrl = document.getElementById('comp-url').value;
				if (!funnelData.userUrl) return alert('Url required');
			}
			if (currentStep === '3') {
				funnelData.aiGap = document.getElementById('ai-gap').value;
			}
			goToStep(parseInt(currentStep) + 1);
		});
	});

	// Step 4: Final Form
	document.getElementById('audit-lead-form').addEventListener('submit', (e) => {
		e.preventDefault();
		funnelData.name = document.getElementById('user-name').value;
		funnelData.email = document.getElementById('user-email').value;
		startSimulation();
	});

	function startSimulation() {
		steps.forEach(s => s.classList.remove('active'));
		document.getElementById('simulation-step').classList.add('active');
		progressIndicator.parentElement.style.display = 'none';

		const logs = [
			"> Initializing DOJJJO_ENGINE v4.2...",
			"> Analyzing Target: " + funnelData.userUrl,
			"> Benchmarking Entity Velocity...",
			"> DETECTED: Semantic Atrophy in niche: " + funnelData.industry,
			"> Cross-referencing " + funnelData.compUrl + " citation share...",
			"> WARNING: Competitor Knowledge Graph node is 3.5x denser",
			"> Calculating Production Readiness...",
			"> FAILED: Current infrastructure cannot support high-velocity shipping",
			"> Finalizing Diagnostic..."
		];

		const logBox = document.getElementById('terminal-logs');
		const simProgress = document.getElementById('sim-progress');
		const simStatus = document.getElementById('sim-status');
		
		let currentLog = 0;
		const interval = setInterval(() => {
			if (currentLog < logs.length) {
				const p = document.createElement('p');
				p.className = 'log-line';
				p.innerText = logs[currentLog];
				logBox.appendChild(p);
				simProgress.style.width = ((currentLog + 1) / logs.length) * 100 + '%';
				simStatus.innerText = logs[currentLog].replace('> ', '').toUpperCase();
				currentLog++;
			} else {
				clearInterval(interval);
				setTimeout(generateResults, 800);
			}
		}, 500);
	}

	function goToStep(num) {
		steps.forEach(s => s.classList.remove('active'));
		const target = document.querySelector(`[data-step="${num}"]`);
		if (target) {
			target.classList.add('active');
			progressIndicator.style.width = ((num - 1) / 3) * 100 + '%';
		}
	}

	function generateResults() {
		steps.forEach(s => s.classList.remove('active'));
		resultsStep.classList.add('active');
		progressIndicator.parentElement.style.display = 'none';
		
		const scoreElement = document.getElementById('authority-score');
		const authorityScore = Math.floor(Math.random() * (45 - 18 + 1) + 18); 
		scoreElement.innerText = authorityScore;

		const megaPrompt = `### SYSTEM ROLE: DOJJJO STUDIO ARCHITECT
Act as a Fractional Product Specialist & Strategic Designer. Conduct a brutal diagnostic of my brand's market readiness and AI authority.

### CONTEXT:
- TARGET PRODUCT: ${funnelData.userUrl}
- COMPETITIVE BENCHMARK: ${funnelData.compUrl}
- IDENTIFIED FRICTION: ${funnelData.aiGap}

### MISSION:
1. CITATION AUDIT: Search for this brand using "high commercial intent" queries. Is the AI citing them or the competitor?
2. PRODUCTION GAP: Based on their industry (${funnelData.industry}), why is their shipping velocity stalled?
3. DOJJJO ROADMAP: List 3 technical or visual assets they must deploy to decrease the time between idea and execution.

### OUTPUT:
Provide an unfiltered, technical diagnosis. Be the Fractional CPO the brand needs.`;

		document.getElementById('custom-prompt-output').innerText = megaPrompt;
	}

	document.getElementById('copy-prompt').addEventListener('click', () => {
		const text = document.getElementById('custom-prompt-output').innerText;
		navigator.clipboard.writeText(text);
		alert('Diagnostic Prompt Copied!');
	});
</script>

<style>
	.diagnostic-container {
		max-width: 900px;
		margin: 0 auto;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 20px;
		padding: var(--space-xl) var(--space-gutter);
		min-height: 500px;
		position: relative;
		overflow: hidden;
	}

	.step { display: none; }
	.step.active { display: block; animation: slideInCustom 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

	@keyframes slideInCustom {
		from { opacity: 0; transform: translateX(30px); }
		to { opacity: 1; transform: translateX(0); }
	}

	.step-header { margin-bottom: var(--space-xl); text-align: center; }
	.step-num { font-family: monospace; color: var(--color-accent); letter-spacing: 0.1em; font-size: 0.75rem; }
	.step-header h1 { margin: 1rem 0; font-size: 2.5rem; letter-spacing: -0.02em; }

	.options-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--space-md);
	}

	.option-card {
		background: var(--color-bg);
		border: 1px solid var(--color-border);
		padding: var(--space-lg);
		border-radius: 12px;
		cursor: pointer;
		transition: all 0.2s ease-in-out;
		text-align: left;
		color: white;
		width: 100%;
	}

	.option-card:hover { border-color: var(--color-accent); background: var(--color-surface-soft); transform: translateY(-5px); }
	.option-card .icon { font-size: 1.5rem; color: var(--color-accent); display: block; margin-bottom: 0.5rem; }
    .option-card h3 { font-size: 1.1rem; margin-bottom: 0.25rem; }

	.input-stack { max-width: 500px; margin: 0 auto; width: 100%; }
	.form-group { margin-bottom: 1.5rem; width: 100%; }
	.form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.75rem; color: var(--color-text-secondary); font-family: monospace; }
	
	input, textarea {
		width: 100%;
		padding: 1rem;
		background: var(--color-bg);
		border: 1px solid var(--color-border);
		border-radius: 8px;
		color: white;
		font-family: inherit;
		box-sizing: border-box;
	}

	input:focus, textarea:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

	/* Simulation UI */
	.terminal-simulation {
		background: #000;
		border: 1px solid var(--color-border);
		border-radius: 12px;
		padding: 1.5rem;
		font-family: monospace;
		box-shadow: 0 20px 40px rgba(0,0,0,0.5);
	}

	.terminal-logs { height: 180px; overflow-y: auto; margin-bottom: 2rem; }
	.log-line { font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.5rem; border-left: 2px solid var(--color-accent); padding-left: 0.75rem; animation: logFade 0.3s ease-out forwards; }

	@keyframes logFade {
		from { opacity: 0; transform: translateX(-10px); }
		to { opacity: 1; transform: translateX(0); }
	}

	.progress-indicator-box { display: flex; flex-direction: column; gap: 0.5rem; }
	.progress-bar-small { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; overflow: hidden; }
	#sim-progress { height: 100%; background: var(--color-accent); width: 0%; transition: width 0.4s ease; }
	#sim-status { font-size: 0.6rem; color: var(--color-accent); letter-spacing: 0.1em; font-family: monospace; }

	/* Progress Bar (Global) */
	.progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--color-border); border-radius: 0 0 20px 20px; overflow: hidden; }
	#progress-indicator { height: 100%; background: var(--color-accent); transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

	/* Results UI */
	#results-step { display: none; }
	#results-step.active { display: block; animation: scaleUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

	@keyframes scaleUp {
		from { opacity: 0; transform: scale(0.95); }
		to { opacity: 1; transform: scale(1); }
	}

	.result-header {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--space-lg);
		margin-bottom: var(--space-xl);
		border-bottom: 1px solid var(--color-border);
		padding-bottom: var(--space-xl);
		text-align: center;
	}

	@media (min-width: 768px) {
		.result-header { flex-direction: row; text-align: left; }
		.step-header h1 { font-size: 3rem; }
	}

	.score-circle {
		width: 120px;
		height: 120px;
		border: 4px solid var(--color-accent);
		border-radius: 50%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
		background: rgba(59, 130, 246, 0.05);
	}

	#authority-score { font-size: 3rem; font-weight: 900; color: var(--color-accent); line-height: 1; }
	.score-circle label { font-size: 0.55rem; text-transform: uppercase; font-family: monospace; margin-top: 4px; letter-spacing: 0.05em; }

	.dual-path-grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: var(--space-lg);
	}

	@media (min-width: 992px) {
		.dual-path-grid { grid-template-columns: 1fr 1.2fr; }
	}

	.path-card {
		padding: var(--space-lg);
		border: 1px solid var(--color-border);
		border-radius: 16px;
		display: flex;
		flex-direction: column;
		background: rgba(255, 255, 255, 0.02);
	}

	.path-card.featured {
		border-color: var(--color-accent);
		background: var(--color-surface);
		position: relative;
		box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2);
	}

	.featured .badge {
		position: absolute;
		top: -12px;
		left: 50%;
		transform: translateX(-50%);
		background: var(--color-accent);
		padding: 0.35rem 1rem;
		border-radius: 100px;
		font-size: 0.65rem;
		font-weight: 800;
        letter-spacing: 0.05em;
	}

	.prompt-box { background: #000; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; position: relative; border: 1px solid var(--color-border); }
	pre { font-size: 0.75rem; color: var(--color-text-secondary); white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-family: monospace; line-height: 1.6; }

	.copy-btn { margin-top: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--color-accent); color: var(--color-accent); padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-family: monospace; font-size: 0.8rem; width: 100%; transition: all 0.2s ease; }
	.copy-btn:hover { background: var(--color-accent); color: white; }

	.benefit-list { list-style: none; padding: 0; margin-top: 1.5rem; }
	.benefit-list li { margin-bottom: 0.75rem; font-size: 0.85rem; color: var(--color-text-secondary); display: flex; align-items: center; }
	.benefit-list li::before { content: '✔'; color: var(--color-accent); margin-right: 0.75rem; font-weight: bold; }

	.path-note { font-size: 0.65rem; color: #ff4d4d; margin-top: 1rem; opacity: 0.7; font-style: italic; }

	@media (max-width: 640px) {
		.diagnostic-container { padding: var(--space-lg) var(--space-gutter); border-radius: 12px; margin: 0; }
		.step-header h1 { font-size: 1.75rem; }
        .score-circle { width: 100px; height: 100px; }
        #authority-score { font-size: 2.5rem; }
	}
</style>
