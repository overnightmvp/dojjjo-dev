---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Revenue Risk Calculator" description="Calculate the annual market share erosion caused by AI invisibility and product friction.">
	<main class="container animate-fade-in" style="padding: var(--space-xl) 0;">
		<div id="risk-funnel" class="diagnostic-container">
			
			<!-- STEP 1: REVENUE BRACKET -->
			<div class="step active" data-step="1">
				<div class="step-header">
					<span class="step-num">STEP_01 // FINANCIAL_EXPOSURE</span>
					<h1>Current Revenue Scale</h1>
					<p>Select your annual revenue bracket to calculate "Erosion Potential."</p>
				</div>
				<div class="options-grid">
					<button class="option-card" data-value="1-5M">
						<span class="icon">▼</span>
						<h3>$1M - $5M</h3>
					</button>
					<button class="option-card" data-value="5-20M">
						<span class="icon">▼▼</span>
						<h3>$5M - $20M</h3>
					</button>
					<button class="option-card" data-value="20-100M">
						<span class="icon">▼▼▼</span>
						<h3>$20M - $100M</h3>
					</button>
					<button class="option-card" data-value="100M+">
						<span class="icon">✖</span>
						<h3>$100M+</h3>
					</button>
				</div>
			</div>

			<!-- STEP 2: DOMAIN -->
			<div class="step" data-step="2">
				<div class="step-header">
					<span class="step-num">STEP_02 // DOMAIN_MAPPING</span>
					<h1>Market Displacement</h1>
					<p>Where is the capital currently flowing in your niche?</p>
				</div>
				<div class="input-stack">
					<div class="form-group">
						<label>Your Brand/Product URL</label>
						<input type="url" id="user-url" placeholder="https://yourbrand.com" required />
					</div>
					<div class="form-group">
						<label>Primary Authority Competitor</label>
						<input type="url" id="comp-url" placeholder="https://competitor.com" required />
					</div>
					<button class="btn btn-primary next-step">Analyze Market Velocity</button>
				</div>
			</div>

			<!-- STEP 3: TRAFFIC -->
			<div class="step" data-step="3">
				<div class="step-header">
					<span class="step-num">STEP_03 // TRAFFIC_VOLATILITY</span>
					<h1>Displacement Risk</h1>
					<p>Estimate your monthly organic traffic to determine erosion impact.</p>
				</div>
				<div class="input-stack">
					<div class="form-group">
						<label>Monthly Organic Visitors</label>
						<input type="number" id="traffic-vol" placeholder="e.g. 50000" />
					</div>
					<button class="btn btn-primary next-step">Calculate Erosion Impact</button>
				</div>
			</div>

			<!-- STEP 4: LEAD -->
			<div class="step" data-step="4">
				<div class="step-header">
					<span class="step-num">STEP_04 // SECURING_THE_Moat</span>
					<h1>Calculation Pending</h1>
					<p>We've detected a significant "Market Share Bleed." Enter your details to reveal the dynamic loss projection.</p>
				</div>
				<form id="risk-lead-form">
					<div class="input-stack">
						<div class="form-group" style="margin-bottom: 2rem;">
							<label>Work Email</label>
							<input type="email" id="user-email" placeholder="ceo@company.com" required />
						</div>
						<button type="submit" class="btn btn-primary">See My Revenue Risk_</button>
					</div>
				</form>
			</div>

			<!-- STEP 5: SIMULATION -->
			<div class="step" data-step="simulation" id="simulation-step">
				<div class="step-header">
					<span class="step-num">STATUS: QUANTIFYING_EROSION</span>
					<h1>Analyzing Capital Flow_</h1>
					<p>Simulating market share displacement in the AI Economy...</p>
				</div>
				<div class="terminal-simulation">
					<div class="terminal-logs" id="terminal-logs">
						<p class="log-line">> Mapping Competitor Citation Velocity...</p>
					</div>
					<div class="progress-indicator-box">
						<div class="progress-bar-small">
							<div id="sim-progress"></div>
						</div>
						<span id="sim-status">CALCULATING_SHARE_LOSS...</span>
					</div>
				</div>
			</div>

			<!-- RESULTS -->
			<div class="step" data-step="results" id="results-step">
				<div class="result-header">
					<div class="score-circle">
						<span id="risk-loss-val">$1.2M</span>
						<label>EST_ANNUAL_LOSS</label>
					</div>
					<div class="result-text">
						<h2 style="color: var(--color-accent); font-size: 2.5rem; margin-bottom: 0.5rem;">CRITICAL_SHARE_EROSION</h2>
						<p>Your "Invisibility" is costed at approximately <strong id="loss-label" class="text-white">$1.2M</strong> in lost pipeline annually. Total displacement predicted within 18 months.</p>
					</div>
				</div>

				<div class="dual-path-grid">
					<div class="path-card surface">
						<h3>Option 1: The Loss Mitigation Prompt</h3>
						<p>Use this prompt to audit your "Cost of Inaction" across 5 major LLMs and identify the revenue leaks.</p>
						<div class="prompt-box">
							<pre id="custom-prompt-output"></pre>
							<button class="copy-btn" id="copy-prompt">Copy Risk Prompt_</button>
						</div>
					</div>

					<div class="path-card surface featured">
						<div class="badge">URGENT INTERVENTION</div>
						<h3>Option 2: Recovery Strategy</h3>
						<p>Retain the DOJJJO studio to plug the revenue leaks via the Authority Loop and technical production updates.</p>
						<a href="https://calendly.com/d/ctbg-rn5-x7j/johnny-toshio-30-minutes-intro" class="btn btn-primary w-full">Schedule Briefing_</a>
						<ul class="benefit-list">
							<li>Competitor "Signal Hijack" Audit</li>
							<li>Revenue Preservation Roadmap</li>
							<li>30-Day Authority Recovery Plan</li>
						</ul>
					</div>
				</div>
			</div>

			<div class="progress-bar">
				<div id="progress-indicator"></div>
			</div>
		</div>
	</main>
</Layout>

<script is:inline>
	let funnelData = {
		revenue: '',
		userUrl: '',
		compUrl: '',
		traffic: 0,
		email: '',
		projectedLoss: ''
	};

	const steps = document.querySelectorAll('.step');
	const progressIndicator = document.getElementById('progress-indicator');
	const resultsStep = document.getElementById('results-step');

	document.querySelectorAll('.option-card').forEach(card => {
		card.addEventListener('click', () => {
			funnelData.revenue = card.dataset.value;
			goToStep(2);
		});
	});

	document.querySelectorAll('.next-step').forEach(btn => {
		btn.addEventListener('click', () => {
			const currentStep = btn.closest('.step').dataset.step;
			if (currentStep === '2') {
				funnelData.userUrl = document.getElementById('user-url').value;
				funnelData.compUrl = document.getElementById('comp-url').value;
				if (!funnelData.userUrl) return alert('Url required');
			}
			if (currentStep === '3') {
				funnelData.traffic = parseInt(document.getElementById('traffic-vol').value) || 0;
			}
			goToStep(parseInt(currentStep) + 1);
		});
	});

	document.getElementById('risk-lead-form').addEventListener('submit', (e) => {
		e.preventDefault();
		funnelData.email = document.getElementById('user-email').value;
		startSimulation();
	});

	function startSimulation() {
		steps.forEach(s => s.classList.remove('active'));
		document.getElementById('simulation-step').classList.add('active');
		progressIndicator.parentElement.style.display = 'none';

		const logs = [
			"> Assessing traffic retention for " + funnelData.userUrl,
			"> Detection: AI agents bypassing landing pages",
			"> Analyzing CITATION_SHARE of " + funnelData.compUrl,
			"> WARNING: High Semantic Correlation for competitor",
			"> Calculating annual market share erosion...",
			"> Revenue Risk: CRITICAL_THRESHOLD_EXCEEDED"
		];

		const logBox = document.getElementById('terminal-logs');
		const simProgress = document.getElementById('sim-progress');
		const simStatus = document.getElementById('sim-status');
		
		let currentLog = 0;
		const interval = setInterval(() => {
			if (currentLog < logs.length) {
				const p = document.createElement('p');
				p.className = 'log-line';
				p.innerText = logs[currentLog];
				logBox.appendChild(p);
				simProgress.style.width = ((currentLog + 1) / logs.length) * 100 + '%';
				simStatus.innerText = logs[currentLog].replace('> ', '').toUpperCase();
				currentLog++;
			} else {
				clearInterval(interval);
				setTimeout(generateResults, 800);
			}
		}, 700);
	}

	function goToStep(num) {
		steps.forEach(s => s.classList.remove('active'));
		const target = document.querySelector(`[data-step="${num}"]`);
		if (target) {
			target.classList.add('active');
			progressIndicator.style.width = ((num - 1) / 3) * 100 + '%';
		}
	}

	function generateResults() {
		steps.forEach(s => s.classList.remove('active'));
		resultsStep.classList.add('active');
		
		const lossVal = document.getElementById('risk-loss-val');
		const lossLabel = document.getElementById('loss-label');
		
		let multiplier = 0;
		if (funnelData.revenue === '1-5M') multiplier = 0.15;
		if (funnelData.revenue === '5-20M') multiplier = 0.22;
		if (funnelData.revenue === '20-100M') multiplier = 0.30;
		if (funnelData.revenue === '100M+') multiplier = 0.45;

		const estimatedLoss = (multiplier * 1000000).toLocaleString();
		
		lossVal.innerText = `$${estimatedLoss}`;
		lossLabel.innerText = `$${estimatedLoss}`;

		const megaPrompt = `### SYSTEM ROLE: DOJJJO REVENUE ARCHITECT
Act as a B2B Financial Analyst and Strategic Product specialist. Calculate the market share displacement for ${funnelData.userUrl} due to "Citation Friction" and "Execution Gaps."

### CONTEXT:
- SCALE: ${funnelData.revenue} Bracket
- PRODUCT: ${funnelData.userUrl}
- COMPETITOR: ${funnelData.compUrl}

### MISSION:
1. CITATION AUDIT: Compare the citation frequency of the two brands across agentic platforms.
2. EROSION MODEL: Calculate the projected pipeline loss if current "Invisibility" persists.
3. RECOVERY PLAN: List 3 technical assets required to plug the revenue leaks.

### OUTPUT:
Provide a Technical Revenue Risk Report citing $ value lost.`;

		document.getElementById('custom-prompt-output').innerText = megaPrompt;
	}

	document.getElementById('copy-prompt').addEventListener('click', () => {
		const text = document.getElementById('custom-prompt-output').innerText;
		navigator.clipboard.writeText(text);
		alert('Risk Prompt Copied!');
	});
</script>

<style>
	.diagnostic-container {
		max-width: 900px;
		margin: 0 auto;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 20px;
		padding: var(--space-xl);
		min-height: 500px;
		position: relative;
		overflow: hidden;
	}

	.step { display: none; }
	.step.active { display: block; animation: slideIn 0.5s ease forwards; }
	@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

	.step-header { margin-bottom: var(--space-xl); text-align: center; }
	.step-num { font-family: monospace; color: var(--color-accent); font-size: 0.75rem; letter-spacing: 0.1em; }
    .step-header h1 { margin: 1rem 0; font-size: 2.5rem; letter-spacing: -0.02em; }
	
	.options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
	.option-card {
		background: var(--color-bg);
		border: 1px solid var(--color-border);
		padding: 2rem;
		border-radius: 12px;
		cursor: pointer;
		text-align: left;
		color: white;
		transition: all 0.2s;
	}
	.option-card:hover { border-color: var(--color-accent); transform: translateY(-5px); background: var(--color-surface-soft); }
	.option-card .icon { display: block; font-size: 1.5rem; color: var(--color-accent); margin-bottom: 0.5rem; }

	.input-stack { max-width: 500px; margin: 0 auto; }
	.form-group { margin-bottom: 1.5rem; text-align: left; }
	.form-group label { display: block; font-size: 0.75rem; color: var(--color-text-secondary); margin-bottom: 0.5rem; font-family: monospace; }
	
	input {
		width: 100%;
		padding: 1rem;
		background: var(--color-bg);
		border: 1px solid var(--color-border);
		border-radius: 8px;
		color: white;
	}

	.terminal-simulation { background: #000; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--color-border); font-family: monospace; }
	.log-line { font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.5rem; border-left: 2px solid var(--color-accent); padding-left: 0.75rem; }
	
	.score-circle {
		width: 150px;
		height: 150px;
		border: 4px solid var(--color-accent);
		border-radius: 50%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		background: rgba(59,130,246,0.1);
	}
	#risk-loss-val { font-size: 2rem; font-weight: 900; color: var(--color-accent); }
	.score-circle label { font-size: 0.55rem; opacity: 0.5; margin-top: 4px; font-family: monospace; }

	.result-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem; border-bottom: 1px solid var(--color-border); padding-bottom: 2rem; }
	
	.dual-path-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
	.path-card { padding: 1.5rem; border: 1px solid var(--color-border); border-radius: 16px; background: rgba(255,255,255,0.02); }
	.path-card.featured { border-color: var(--color-accent); position: relative; background: var(--color-surface); box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2); }
	.badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--color-accent); font-size: 0.65rem; padding: 0.35rem 1rem; border-radius: 100px; font-weight: bold; }

	.prompt-box { background: #000; padding: 1.5rem; border-radius: 12px; margin: 1rem 0; border: 1px solid var(--color-border); }
	pre { font-size: 0.75rem; color: var(--color-text-secondary); white-space: pre-wrap; height: 150px; overflow-y: auto; line-height: 1.6; }
	
	.copy-btn { width: 100%; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--color-accent); border-radius: 8px; color: var(--color-accent); cursor: pointer; font-size: 0.8rem; font-family: monospace; transition: all 0.2s; }
    .copy-btn:hover { background: var(--color-accent); color: white; }
	
	.progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--color-border); }
	#progress-indicator { height: 100%; background: var(--color-accent); width: 0%; transition: width 0.3s; }

    .benefit-list { list-style: none; padding: 0; margin-top: 1.5rem; }
	.benefit-list li { margin-bottom: 0.75rem; font-size: 0.85rem; color: var(--color-text-secondary); display: flex; align-items: center; }
	.benefit-list li::before { content: '✔'; color: var(--color-accent); margin-right: 0.75rem; font-weight: bold; }

	@media (max-width: 992px) {
		.result-header { flex-direction: column; text-align: center; }
		.dual-path-grid { grid-template-columns: 1fr; }
	}
    
    @media (max-width: 640px) {
        .step-header h1 { font-size: 1.75rem; }
        .score-circle { width: 120px; height: 120px; }
        #risk-loss-val { font-size: 1.5rem; }
    }
</style>
